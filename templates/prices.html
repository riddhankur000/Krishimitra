{% extends "base.html" %}

{% block title %}Market Prices - Krishimitra{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Market Prices</h1>
        <p>Real-time mandi prices across India</p>
    </div>
</div>

<section>
    <div class="container">
        <div class="card">
            <h3>Filter Prices</h3>
            <form method="post" action="{{ url_for('prices') }}">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="commodity">Commodity</label>
                        <select id="commodity" name="commodity" class="form-control" onchange="filterStates()">
                            <option value="">All Commodities</option>
                            {% for item in Commodity %}
                            <option value="{{ item }}" {% if item == commodity_filter %}selected{% endif %}>{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state" name="state" class="form-control" onchange="filterCommodities()">
                            <option value="">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}" {% if state == state_filter %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if is_commodity %}
        <div class="table-container">
            <table id="priceTable">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>APMC</th>
                        <th>Commodity</th>
                        <th>Min Price</th>
                        <th>Modal Price</th>
                        <th>Max Price</th>
                        <th>Transport Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% if prices %}
                        {% for price in prices %}
                        <tr>
                            <td><strong>{{ price.state }}</strong></td>
                            <td>{{ price.APMC }}</td>
                            <td>{{ price.Commodity }}</td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Min_Price }}</span></td>
                            <td><span style="color: var(--primary-color); font-weight: bold;">₹{{ price.Modal_Price }}</span></td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Max_Price }}</span></td>
                            <td>
                                <a href="/transport-calculator" class="btn" style="padding: 0.4rem 1rem; font-size: 0.9rem;">
                                    <i class="fas fa-calculator"></i> Calculate
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6" style="text-align: center; padding: 2rem;">No data.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>    
        {% endif %}

        {% if bar_chart_data %}
    <div class="extended_container">    
        <div class="card mt-3">
            <h3><i class="fas fa-map-marker-alt"></i> State Analysis: {{ bar_chart_data.state_name }}</h3>
            <div class="grid grid-2">
                <div>
                    <h5 style="text-align:center; color: var(--text-light);">Top Price Mandis (Best for Selling)</h5>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="stateDescChart"></canvas>
                    </div>
                </div>
                <div>
                    <h5 style="text-align:center; color: var(--text-light);">Low Price Mandis (Worst for Selling)</h5>
                    <div style="height: 300px; width: 100%;">
                        <canvas id="stateAscChart"></canvas>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="card mt-3">
            <h3><i class="fas fa-globe-asia"></i> National Analysis: All India</h3>
            <div class="grid grid-2">
                <div>
                    <h5 style="text-align:center; color: var(--text-light);">Top Price Mandis (Best for Selling)</h5>
                    <div style="height: 450px; width: 100%;">
                        <canvas id="natDescChart"></canvas>
                    </div>
                </div>
                <div>
                    <h5 style="text-align:center; color: var(--text-light);">Low Price Mandis (Worst for Selling)</h5>
                    <div style="height: 450px; width: 100%; padding-left: -5vw;">
                        <canvas id="natAscChart"></canvas>
                    </div>
                </div>
                
            </div>
        </div>
        

        <div class="card mt-3">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3><i class="fas fa-chart-area"></i> Historical Price Trends</h3>
        {% if chart_data %}
        <div style="min-width: 200px;">
            <select id="chartMarketSelect" class="form-control" onchange="updateHistoricalChart()">
                <option value="">-- State vs India Average --</option>
                {% for market in chart_data.market_list %}
                <option value="{{ market }}">{{ market }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    <div style="height: 400px; width: 100%;">
        <canvas id="priceTrendChart"></canvas>
    </div>
    </div>
    

            
        
        </div>
    </div>
    {% endif %}
</section>

<script>
    // ... (Keep filterCommodities and filterStates functions) ...
    const stateMap = {{ state_map | tojson | safe }};
    const commodityMap = {{ commodity_map | tojson | safe }};
    const allStates = {{ states | tojson | safe }};
    const allCommodities = {{ Commodity | tojson | safe }};

    function filterCommodities() {
        const stateSelect = document.getElementById("state");
        const commoditySelect = document.getElementById("commodity");
        const selectedState = stateSelect.value;
        const currentCommodity = commoditySelect.value;

        // Clear current commodity options
        commoditySelect.innerHTML = '<option value="">All Commodities</option>';

        let optionsToAdd = [];

        if (selectedState && stateMap[selectedState]) {
            // If a state is selected, only show commodities for that state
            optionsToAdd = stateMap[selectedState];
        } else {
            // If no state selected, show all commodities
            optionsToAdd = allCommodities;
        }

        // Populate the dropdown
        optionsToAdd.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            option.text = item;
            if (item === currentCommodity) {
                option.selected = true;
            }
            commoditySelect.appendChild(option);
        });
    }

    function filterStates() {
        const stateSelect = document.getElementById("state");
        const commoditySelect = document.getElementById("commodity");
        const selectedCommodity = commoditySelect.value;
        const currentState = stateSelect.value;

        // Clear current state options
        stateSelect.innerHTML = '<option value="">All States</option>';

        let optionsToAdd = [];

        if (selectedCommodity && commodityMap[selectedCommodity]) {
            // If a commodity is selected, only show states having that commodity
            optionsToAdd = commodityMap[selectedCommodity];
        } else {
            // If no commodity selected, show all states
            optionsToAdd = allStates;
        }

        // Populate the dropdown
        optionsToAdd.forEach(state => {
            const option = document.createElement("option");
            option.value = state;
            option.text = state;
            if (state === currentState) {
                option.selected = true;
            }
            stateSelect.appendChild(option);
        });
    }

    // --- NEW: BAR CHART LOGIC ---
    {% if bar_chart_data %}
        const barData = {{ bar_chart_data | tojson | safe }};
        
        function createComboChart(ctxId, labels, dataPoints, color, label) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            const natAvg = barData.national_avg;
            const stAvg = barData.state_avg;

            // Create Avg Line Arrays
            const natAvgArray = Array(labels.length).fill(natAvg);
            const stAvgArray = Array(labels.length).fill(stAvg);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: label,
                            data: dataPoints,
                            backgroundColor: color, // Dynamic Color
                            borderWidth: 1,
                            maxBarThickness: 40,
                            order: 2
                        },
                        {
                            label: 'India Avg (₹' + natAvg + ')',
                            data: natAvgArray,
                            type: 'line',
                            borderColor: '#95a5a6', // Grey
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        },
                        {
                            label: 'State Avg (₹' + stAvg + ')',
                            data: stAvgArray,
                            type: 'line',
                            borderColor: '#3498db', // Blue
                            borderWidth: 2,
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    },
                    plugins: {
                        legend: { display: false } // Hide legend to save space if preferred
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Green for Cheapest, Red for Costliest
            const colorCostly = 'rgba(46, 204, 113, 0.7)'; // Green
            const colorCheap = 'rgba(231, 76, 60, 0.7)'; // Red

            // 1. State Charts
            if(barData.state_asc.labels.length > 0) {
                createComboChart('stateAscChart', barData.state_asc.labels, barData.state_asc.data, colorCheap, 'Price');
                createComboChart('stateDescChart', barData.state_desc.labels, barData.state_desc.data, colorCostly, 'Price');
            }

            // 2. National Charts
            createComboChart('natAscChart', barData.national_asc.labels, barData.national_asc.data, colorCheap, 'Price');
            createComboChart('natDescChart', barData.national_desc.labels, barData.national_desc.data, colorCostly, 'Price');
        });
    {% endif %}
    // --- HISTORICAL CHART LOGIC (Renamed function to avoid conflicts) ---
    {% if chart_data %}
        const chartData = {{ chart_data | tojson | safe }};
        let histChart = null;

        function initHistoricalChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            
            const initialDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'State Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.1
                }
            ];

            histChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: initialDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function updateHistoricalChart() {
            const marketSelect = document.getElementById('chartMarketSelect');
            const selectedMarket = marketSelect.value;

            let newDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'State Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: !selectedMarket,
                    tension: 0.1
                }
            ];

            if (selectedMarket && chartData.markets[selectedMarket]) {
                newDatasets.push({
                    label: selectedMarket + ' Market',
                    data: chartData.markets[selectedMarket],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                    borderWidth: 3,
                    fill: true,
                    pointRadius: 4,
                    tension: 0.1
                });
            }
            histChart.data.datasets = newDatasets;
            histChart.update();
        }

        // Add this to the event listener
        document.addEventListener('DOMContentLoaded', function() {
            initHistoricalChart();
        });
    {% endif %}
</script>

{% endblock %}