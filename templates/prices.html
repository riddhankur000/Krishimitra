{% extends "base.html" %}

{% block title %}Market Prices - Krishimitra{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Market Prices</h1>
        <p>Real-time mandi prices across India</p>
    </div>
</div>

<section>
    <div class="container">
        <div class="card">
            <h3>Filter Prices</h3>
            <form method="post" action="{{ url_for('prices') }}">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="commodity">Commodity</label>
                        <select id="commodity" name="commodity" class="form-control" onchange="filterStates()">
                            <option value="">All Commodities</option>
                            {% for item in Commodity %}
                            <option value="{{ item }}" {% if item == commodity_filter %}selected{% endif %}>{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state" name="state" class="form-control" onchange="filterCommodities()">
                            <option value="">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}" {% if state == state_filter %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if is_commodity %}
        <div class="table-container">
            <table id="priceTable">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>APMC</th>
                        <th>Commodity</th>
                        <th>Min Price</th>
                        <th>Modal Price</th>
                        <th>Max Price</th>
                        <th>Transport Cost</th>
                    </tr>
                </thead>
                <tbody>
                    {% if prices %}
                        {% for price in prices %}
                        <tr>
                            <td><strong>{{ price.state }}</strong></td>
                            <td>{{ price.APMC }}</td>
                            <td>{{ price.Commodity }}</td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Min_Price }}</span></td>
                            <td><span style="color: var(--primary-color); font-weight: bold;">₹{{ price.Modal_Price }}</span></td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Max_Price }}</span></td>
                            <td>
                                <a href="/transport-calculator" class="btn" style="padding: 0.4rem 1rem; font-size: 0.9rem;">
                                    <i class="fas fa-calculator"></i> Calculate
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="7" style="text-align: center; padding: 2rem;">No data available.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if bar_chart_data %}
        <div class="extended_container">    
            {% if bar_chart_data.has_state_data %}
            <div class="card mt-3">
                <h3><i class="fas fa-map-marker-alt"></i> State Analysis: {{ bar_chart_data.state_name }}</h3>
                <div class="grid grid-2">
                    <div>
                        <h5 style="text-align:center; color: var(--text-light);">Top Price Mandis (Best for Selling)</h5>
                        <div style="height: 300px; width: 100%;">
                            <canvas id="stateDescChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h5 style="text-align:center; color: var(--text-light);">Low Price Mandis (Worst for Selling)</h5>
                        <div style="height: 300px; width: 100%;">
                            <canvas id="stateAscChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mt-3" style="background: #fff3cd; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Limited State Data:</strong> Only {{ prices|length }} mandi(s) found for {{ commodity_filter }} in {{ state_filter }}. 
                    State-level comparison charts require multiple mandis. Please view the National Analysis below for broader market insights.
                </p>
            </div>
            {% endif %}

            <div class="card mt-3">
                <h3><i class="fas fa-globe-asia"></i> National Analysis: All India</h3>
                <div class="grid grid-2">
                    <div>
                        <h5 style="text-align:center; color: var(--text-light);">Top Price Mandis (Best for Selling)</h5>
                        <div style="height: 450px; width: 100%;">
                            <canvas id="natDescChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h5 style="text-align:center; color: var(--text-light);">Low Price Mandis (Worst for Selling)</h5>
                        <div style="height: 450px; width: 100%; padding-left: -5vw;">
                            <canvas id="natAscChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            {% if chart_data %}
            <div class="card mt-3">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3><i class="fas fa-chart-area"></i> Historical Price Trends</h3>
                    <div style="min-width: 200px;">
                        <select id="chartMarketSelect" class="form-control" onchange="updateHistoricalChart()">
                            <option value="">-- State vs India Average --</option>
                            {% for market in chart_data.market_list %}
                            <option value="{{ market }}">{{ market }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div style="height: 400px; width: 100%;">
                    <canvas id="priceTrendChart"></canvas>
                </div>
            </div>
            {%else %}
                <div>
                    <h5><i>No historical data forund for {{commodity_filter}} in {{state_filter}}.</i></h5>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<script>
    const stateMap = {{ state_map | tojson | safe }};
    const commodityMap = {{ commodity_map | tojson | safe }};
    const allStates = {{ states | tojson | safe }};
    const allCommodities = {{ Commodity | tojson | safe }};

    function filterCommodities() {
        const stateSelect = document.getElementById("state");
        const commoditySelect = document.getElementById("commodity");
        const selectedState = stateSelect.value;
        const currentCommodity = commoditySelect.value;

        commoditySelect.innerHTML = '<option value="">All Commodities</option>';

        let optionsToAdd = [];

        if (selectedState && stateMap[selectedState]) {
            optionsToAdd = stateMap[selectedState];
        } else {
            optionsToAdd = allCommodities;
        }

        optionsToAdd.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            option.text = item;
            if (item === currentCommodity) {
                option.selected = true;
            }
            commoditySelect.appendChild(option);
        });
    }

    function filterStates() {
        const stateSelect = document.getElementById("state");
        const commoditySelect = document.getElementById("commodity");
        const selectedCommodity = commoditySelect.value;
        const currentState = stateSelect.value;

        stateSelect.innerHTML = '<option value="">All States</option>';

        let optionsToAdd = [];

        if (selectedCommodity && commodityMap[selectedCommodity]) {
            optionsToAdd = commodityMap[selectedCommodity];
        } else {
            optionsToAdd = allStates;
        }

        optionsToAdd.forEach(state => {
            const option = document.createElement("option");
            option.value = state;
            option.text = state;
            if (state === currentState) {
                option.selected = true;
            }
            stateSelect.appendChild(option);
        });
    }

    {% if bar_chart_data %}
        const barData = {{ bar_chart_data | tojson | safe }};
        
        function createComboChart(ctxId, labels, dataPoints, color, label) {
            if (!labels || labels.length === 0) {
                console.log('No data for chart: ' + ctxId);
                return;
            }

            console.log('Creating chart:', ctxId, 'Labels:', labels, 'Data:', dataPoints);

            const ctx = document.getElementById(ctxId);
            if (!ctx) {
                console.error('Canvas not found:', ctxId);
                return;
            }

            const natAvg = barData.national_avg;
            const stAvg = barData.state_avg;

            const natAvgArray = Array(labels.length).fill(natAvg);
            const stAvgArray = Array(labels.length).fill(stAvg);

            const numericData = dataPoints.map(d => parseFloat(d) || 0);

            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Price (₹/Quintal)',
                            data: numericData,
                            backgroundColor: color,
                            borderColor: color.replace('0.7', '1'),
                            borderWidth: 2,
                            maxBarThickness: 80,
                            minBarLength: 2,
                            order: 2
                        },
                        {
                            label: 'India Avg (₹' + natAvg + ')',
                            data: natAvgArray,
                            type: 'line',
                            borderColor: '#95a5a6',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4,
                            pointBackgroundColor: '#95a5a6',
                            fill: false,
                            order: 1
                        },
                        {
                            label: barData.state_name + ' Avg (₹' + stAvg + ')',
                            data: stAvgArray,
                            type: 'line',
                            borderColor: '#3498db',
                            borderWidth: 2,
                            borderDash: [2, 2],
                            pointRadius: 4,
                            pointBackgroundColor: '#3498db',
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 15,
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '₹' + context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const colorCostly = 'rgba(46, 204, 113, 0.7)';
            const colorCheap = 'rgba(231, 76, 60, 0.7)';

            console.log('Bar chart data:', barData);

            if(barData.has_state_data) {
                if(barData.state_desc.labels.length > 0) {
                    createComboChart('stateDescChart', barData.state_desc.labels, barData.state_desc.data, colorCostly, 'Top Price');
                }
                if(barData.state_asc.labels.length > 0) {
                    createComboChart('stateAscChart', barData.state_asc.labels, barData.state_asc.data, colorCheap, 'Low Price');
                }
            }

            if(barData.national_desc.labels.length > 0) {
                createComboChart('natDescChart', barData.national_desc.labels, barData.national_desc.data, colorCostly, 'Top Price');
            }
            if(barData.national_asc.labels.length > 0) {
                createComboChart('natAscChart', barData.national_asc.labels, barData.national_asc.data, colorCheap, 'Low Price');
            }
        });
    {% endif %}

    {% if chart_data %}
        const chartData = {{ chart_data | tojson | safe }};
        let histChart = null;

        function initHistoricalChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            
            const initialDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: chartData.state_name + ' Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.1
                }
            ];

            histChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: initialDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateHistoricalChart() {
            const marketSelect = document.getElementById('chartMarketSelect');
            const selectedMarket = marketSelect.value;

            let newDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: chartData.state_name + ' Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: !selectedMarket,
                    tension: 0.1
                }
            ];

            if (selectedMarket && chartData.markets[selectedMarket]) {
                newDatasets.push({
                    label: selectedMarket + ' Market',
                    data: chartData.markets[selectedMarket],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                    borderWidth: 3,
                    fill: true,
                    pointRadius: 4,
                    tension: 0.1
                });
            }
            histChart.data.datasets = newDatasets;
            histChart.update();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initHistoricalChart();
        });
    {% endif %}
</script>

{% endblock %}