{% extends "base.html" %}

{% block title %}Market Prices - Krishimitra{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header">
    <div class="container">
        <h1><i class="fas fa-chart-line"></i> Market Prices</h1>
        <p>Real-time mandi prices across India</p>
    </div>
</div>

<section>
    <div class="container">
        <div class="card">
            <h3>Filter Prices</h3>
            <form method="post" action="{{ url_for('prices') }}">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label for="commodity">Commodity</label>
                        <select id="commodity" name="commodity" class="form-control" onchange="filterStates()">
                            <option value="">All Commodities</option>
                            {% for item in Commodity %}
                            <option value="{{ item }}" {% if item == commodity_filter %}selected{% endif %}>{{ item }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="state">State</label>
                        <select id="state" name="state" class="form-control" onchange="filterCommodities()">
                            <option value="">All States</option>
                            {% for state in states %}
                            <option value="{{ state }}" {% if state == state_filter %}selected{% endif %}>{{ state }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </form>
        </div>

        {% if is_commodity %}
        <div class="table-container">
            <table id="priceTable">
                <thead>
                    <tr>
                        <th>State</th>
                        <th>APMC</th>
                        <th>Commodity</th>
                        <th>Min Price</th>
                        <th>Modal Price</th>
                        <th>Max Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% if prices %}
                        {% for price in prices %}
                        <tr>
                            <td><strong>{{ price.state }}</strong></td>
                            <td>{{ price.APMC }}</td>
                            <td>{{ price.Commodity }}</td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Min_Price }}</span></td>
                            <td><span style="color: var(--primary-color); font-weight: bold;">₹{{ price.Modal_Price }}</span></td>
                            <td><span style="color: var(--primary-color);">₹{{ price.Max_Price }}</span></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6" style="text-align: center; padding: 2rem;">No data.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if bar_chart_data %}
        <div class="grid grid-2 mt-3">
            <div class="card">
                <h4><i class="fas fa-map-marker-alt"></i> Cheapest Mandis in {{ bar_chart_data.state_name }}</h4>
                <div style="height: 300px; width: 100%;">
                    <canvas id="stateBarChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h4><i class="fas fa-globe-asia"></i> Cheapest Mandis in India</h4>
                <div style="height: 300px; width: 100%;">
                    <canvas id="nationalBarChart"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card mt-3">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3><i class="fas fa-chart-area"></i> Historical Price Trends</h3>
                {% if chart_data %}
                <div style="min-width: 200px;">
                    <select id="chartMarketSelect" class="form-control" onchange="updateHistoricalChart()">
                        <option value="">-- State vs India Average --</option>
                        {% for market in chart_data.market_list %}
                        <option value="{{ market }}">{{ market }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
            
            {% if chart_data %}
                <div style="position: relative; height:400px; width:100%">
                    <canvas id="priceTrendChart"></canvas>
                </div>
            {% elif historical_msg %}
                <div style="background-color: var(--light-bg); padding: 3rem; text-align: center; border-radius: 5px; margin-top: 1rem;">
                    <p style="margin-top: 1rem; color: #e74c3c; font-weight: bold;">{{ historical_msg }}</p>
                </div>
            {% else %}
                <div style="background-color: var(--light-bg); padding: 3rem; text-align: center; border-radius: 5px; margin-top: 1rem;">
                    <p style="margin-top: 1rem; color: var(--text-light);">Chart visualization will appear here</p>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
    // ... (Keep filterCommodities and filterStates functions) ...
    const stateMap = {{ state_map | tojson | safe }};
    const commodityMap = {{ commodity_map | tojson | safe }};
    const allStates = {{ states | tojson | safe }};
    const allCommodities = {{ Commodity | tojson | safe }};

    function filterCommodities() { /* ... existing code ... */ }
    function filterStates() { /* ... existing code ... */ }

    // --- NEW: BAR CHART LOGIC ---
    {% if bar_chart_data %}
        const barData = {{ bar_chart_data | tojson | safe }};
        
        function createComboChart(ctxId, labels, barDataPoints, natAvg, stAvg) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            
            // Create arrays for the average lines (same value repeated)
            const natAvgArray = Array(labels.length).fill(natAvg);
            const stAvgArray = Array(labels.length).fill(stAvg);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Market Price',
                            data: barDataPoints,
                            backgroundColor: 'rgba(46, 204, 113, 0.6)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'India Avg (₹' + natAvg + ')',
                            data: natAvgArray,
                            type: 'line',
                            borderColor: '#e74c3c', // Red
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        },
                        {
                            label: 'State Avg (₹' + stAvg + ')',
                            data: stAvgArray,
                            type: 'line',
                            borderColor: '#3498db', // Blue
                            borderWidth: 2,
                            borderDash: [2, 2],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }

        // Initialize the two bar charts
        document.addEventListener('DOMContentLoaded', function() {
            // 1. State Chart
            if(barData.state_chart.labels.length > 0) {
                createComboChart(
                    'stateBarChart', 
                    barData.state_chart.labels, 
                    barData.state_chart.data, 
                    barData.national_avg, 
                    barData.state_avg
                );
            }

            // 2. National Chart
            createComboChart(
                'nationalBarChart', 
                barData.national_chart.labels, 
                barData.national_chart.data, 
                barData.national_avg, 
                barData.state_avg
            );
        });
    {% endif %}

    // --- HISTORICAL CHART LOGIC (Renamed function to avoid conflicts) ---
    {% if chart_data %}
        const chartData = {{ chart_data | tojson | safe }};
        let histChart = null;

        function initHistoricalChart() {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            
            const initialDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'State Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.1
                }
            ];

            histChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: initialDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top' } }
                }
            });
        }

        function updateHistoricalChart() {
            const marketSelect = document.getElementById('chartMarketSelect');
            const selectedMarket = marketSelect.value;

            let newDatasets = [
                {
                    label: 'All India Average',
                    data: chartData.national,
                    borderColor: '#95a5a6',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                },
                {
                    label: 'State Average',
                    data: chartData.state,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: !selectedMarket,
                    tension: 0.1
                }
            ];

            if (selectedMarket && chartData.markets[selectedMarket]) {
                newDatasets.push({
                    label: selectedMarket + ' Market',
                    data: chartData.markets[selectedMarket],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                    borderWidth: 3,
                    fill: true,
                    pointRadius: 4,
                    tension: 0.1
                });
            }
            histChart.data.datasets = newDatasets;
            histChart.update();
        }

        // Add this to the event listener
        document.addEventListener('DOMContentLoaded', function() {
            initHistoricalChart();
        });
    {% endif %}
</script>

{% endblock %}